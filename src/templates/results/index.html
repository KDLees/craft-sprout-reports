{% extends "sprout-reports/_layouts/base" %}

{% set title  = report.name|t('sprout-reports') %}
{% set groups = craft.sproutreports.getReportGroups() %}

{% set crumbs = [
	{ label: "Reports"|t('sprout-reports'), url: url('sprout-reports/reports') },
	{ label: "Edit "|t('sprout-reports') ~ report.name, url: report.getEditUrl() }
] %}

{% set selectedTab = 'resultView' %}

{% if dataSource is defined %}
	{% set optionsHtml = dataSource.getOptionsHtml() %}
{% endif %}

{% set extraPageHeaderHtml %}

  <form method="post" accept-charset="UTF-8">
    {{ csrfInput() }}
    <input type="hidden" name="action" value="sprout-reports/reports/export-report">
    <input type="hidden" name="reportId" value="{{ reportId }}">

    <a id="btn-download-csv" class="btn">
	    {{ "Download"|t('sprout-reports') }}
    </a>

		{% if currentUser.can('sproutreports-editReports') %}
	    <a id="modify-options-icon" class="btn" data-icon="settings"></a>
		{% endif %}
  </form>

{% endset %}

{% block content %}

	{% if optionsHtml %}

		<div id="modify-options-panel" style="display:none;">

			<form id="report-options" method="post" accept-charset="UTF-8">
				{{ csrfInput() }}
				<input type="hidden" name="action" value="sprout-reports/reports/update-report">
				{{ redirectInput('sprout-reports/reports/view/' ~ reportId) }}
				<input type="hidden" name="reportId" value="{{ reportId }}">

				{{ optionsHtml | raw }}

				<div class="button">
					<div class="btngroup">
						<input type="submit" class="btn submit" value="{{ 'Update Report'|t('sprout-reports') }}">
					</div>
				</div>

			</form>

			<hr>

		</div>

	{% endif %}

	<div class="tableview sproutreports">
		{% if values is defined and values is iterable and values|length %}
			<div class="tablecontent">
				<table class="data fullwidth">
					<thead>
						<tr>
							{% for label in labels %}
								<th>
									<div {% if loop.index == "1" %}class="first"{% endif %}><h3>{{ label }}</h3></div>
								</th>
							{% endfor %}
						</tr>
					</thead>
					<tbody>
						{% for value in values %}
							<tr class="table_row">
								{% for property in value %}
									<td>
										<div class="item_content">
											{% if report.allowHtml %}
												{{ property|raw }}
											{% else %}
												{{ property }}
											{% endif %}
										</div>
									</td>
								{% endfor %}
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		{% else %}
			<p>{{ "This report currently has no results."|t('sprout-reports') }}</p>
		{% endif %}
	</div>

{% endblock %}

{% do view.registerAssetBundle("barrelstrength\\sproutreports\\assetbundles\\reports\\ReportAsset") %}

{% js %}

	(function(){

		$('#btn-download-csv').on('click', function(event) {

			event.preventDefault();

            $form = $(this).parents('form');
            $form.submit();

		});

		$('#modify-options-icon').on('click', function() {
			$('#modify-options-panel').slideToggle('slow');
		});

	})();

{% endjs %}