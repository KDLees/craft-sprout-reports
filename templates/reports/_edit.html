{% extends "sproutreports/_layouts/base" %}
{% import "_includes/forms" as forms %}

{% set title = "Edit Report" %}

{% set crumbs = [
	{ label: "Reports"|t, url: url('sproutreports') },
	{ label: "Edit Report"|t, url: "" }
] %}

{# From Route #}
{% set previouslySavedReport = '' %}
{% if reportId is defined %}
	{% set previouslySavedReport = craft.sproutReports.reportById(reportId) %}
{% endif %}

{# From failed POST request #}
{% if unsavedReport is defined and unsavedReport is not empty %}
	{% set report = unsavedReport %}
{% else %}
	{% set report = previouslySavedReport %}
{% endif %}

{% set groups = craft.sproutReports.getAllReportGroups('id') %}

{% if groups | length %}
	{% set groupId = craft.request.getQuery('groupId') %}

	{% if not groupId %}
		{% set groupId = groups|keys[0] %}
	{% endif %}

	{% if groups[groupId] is not defined %}
		{% exit 404 %}
	{% endif %}
{% endif %}

{% set response = craft.session.getFlash('response') %}

{% block content %}

	{% if response is not empty %}
	<h2 class="error">{{ response.message }}</h2>
	<p class="code notice">{{ response.dbMessage }}</p>
	{% endif %}

	{% if errorMessage is defined %}
	<h2 style="color: #d00;">{{ errorMessage }}</h2>
	{% endif %}

	<form method="post" action="" data-saveshortcut="1" data-saveshortcut-redirect="sproutreports/reports/edit/{id}" accept-charset="UTF-8">
		<input type="hidden" name="action" value="sproutReports/reports/saveReport">
		<input type="hidden" name="redirect" value="sproutreports">

		{% if reportId is defined %}
			<input type="hidden" name="id" value="{{ reportId }}">
		{% endif %}

		{% if groups | length %}

			{% set groupOptions = [] %}
			{% for group in groups %}
				{% set groupOptions = groupOptions|merge([{ label: group.name, value: group.id }]) %}
			{% endfor %}

			{{ forms.selectField({
				first: true,
				label: "Group"|t,
				instructions: "Which group should this report be displayed in?"|t,
				id: 'groupId',
				name: 'groupId',
				options: groupOptions,
				value: groupId
			}) }}

		{% endif %}

		{{ forms.textField({
			label: "Name"|t,
			name: 'name',
			value: (report.name is defined) ? report.name : "",
			errors: "",
			required: true,
			first: true
		}) }}

		{{ forms.textField({
			label: "Handle"|t,
			name: 'handle',
			value: (report.handle is defined) ? report.handle : "",
			errors: "",
			required: true,
			first: true
		}) }}

		{{ forms.textareaField({
			label: "Description"|t,
			name: 'description',
			class: 'nicetext',
			rows: 4,
			value: (report.description is defined) ? report.description : ""
		}) }}

		{{ forms.textareaField({
			label: "Custom Query"|t,
			name: 'customQuery',
			class: 'code',
			required: true,
			value: (report.customQuery is defined) ? report.customQuery : "",
			rows: 10
		}) }}
		
		{{ forms.checkboxField({
			label:		"This report returns a single number"|t,
			name:		"returnsSingleNumber",
			checked:	report.returnsSingleNumber is defined and report.returnsSingleNumber,
		}) }}

		<div class="button">
			<div class="btngroup">
				<input type="submit" class="btn submit" value="{{ 'Save Report'|t }}">

				<div class="btn submit menubtn"></div>
				<div class="menu">
					<ul>
						<li><a class="formsubmit" data-redirect="sproutreports/reports/edit/{id}">{{ "Save and continue editing"|t }}</a></li>
						<li><a class="formsubmit" data-redirect="sproutreports/reports/new">{{ "Save and add another report"|t }}</a></li>
					</ul>
				</div>
			</div>
		</div>

		{% if reportId is defined %}
			<p>
				<input type="button" class="btn small formsubmit" value="Delete" data-action="sproutReports/reports/deleteReport" data-confirm="Are you sure you want to delete this report?" data-redirect="sproutreports" tabindex="0">
			</p>
		{% endif %}

	</form>

	{{ parent() }}

{% endblock %}