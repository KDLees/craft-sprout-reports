{% extends "sproutreports/_layouts/base" %}

{% import "_includes/forms" as forms %}

{% set title = id is defined and id is not empty ? "Edit Report" : "New Report"%}

{% set crumbs = [
	{ label: "Reports"|t, url: url('sproutreports') },
] %}

{% set groups = craft.sproutReports.getReportGroups() %}

{% if groups | length %}
	{% set groupId = craft.request.getQuery('groupId') %}

	{% if not groupId %}
		{% set groupId = groups|keys[0] %}
	{% endif %}

	{% if groups[groupId] is not defined %}
		{% exit 404 %}
	{% endif %}
{% endif %}

{% set response = craft.session.getFlash('response') %}

{% block main %}

<form method="post" accept-charset="UTF-8">
	{{ getCsrfInput() }}
	<input type="hidden" name="action" value="sproutReports/saveReport">
	<input type="hidden" name="redirect" value="sproutreports">
	<input type="hidden" name="dataSourceId" value="{{ dataSource.id }}">

	<div class="grid first">
		<div class="item" data-position="left" data-min-colspan="2" data-max-colspan="3">
			<div class="pane">

				{% if report is defined and report.hasErrors() %}
					<h2 class="error">Something went wrong.</h2>
					<p class="code notice">More in depth message here.</p>
				{% endif %}

					{% if report is defined %}
						<input type="hidden" name="id" value="{{ report.id }}">
					{% endif %}

					{{ forms.textField({
						label: "Name"|t,
						name: 'name',
						value: (report.name is defined) ? report.name : "",
						errors: "",
						required: true,
						first: true,
						autofocus: true
					}) }}

					{{ forms.textareaField({
						label: "Description"|t,
						name: 'description',
						class: 'nicetext',
						rows: 3,
						value: (report.description is defined) ? report.description : ""
					}) }}

					{% if dataSource is defined %}
						{{ dataSource.getOptionsHtml(report is defined and report.options is defined ? report.options : {}) | raw }}
					{% endif %}

			</div>
		</div>
		<div class="item" data-position="right" data-colspan="1">
			<div class="pane">

				{% if groups | length %}

					{% set groupOptions = [] %}
					{% for group in groups %}
						{% set groupOptions = groupOptions|merge([{ label: group.name, value: group.id }]) %}
					{% endfor %}

					{{ forms.selectField({
						first: true,
						label: "Group"|t,
						instructions: "Which group should this report be displayed in?"|t,
						id: 'groupId',
						name: 'groupId',
						options: groupOptions,
						value: groupId
					}) }}

					{{ forms.lightSwitchField({
						label: 'Enabled'|t,
						name: 'enabled',
						on: report is defined ? report.enabled : true
					})}}
				{% endif %}

			</div>

			<div class="button">
				<div class="btngroup">
					<input type="submit" class="btn submit" value="{{ 'Save Report'|t }}">

					<div class="btn submit menubtn"></div>
					<div class="menu">
						<ul>
							<li><a class="formsubmit" data-redirect="sproutreports/harmony/reports/edit/{id}">{{ "Save and continue editing"|t }}</a></li>
							<li><a class="formsubmit" data-redirect="sproutreports/harmony/reports/new">{{ "Save and add another report"|t }}</a></li>
						</ul>
					</div>
				</div>
			</div>

			{% if report is defined %}
				<p>
					<input type="button" class="btn small formsubmit" value="Delete" data-action="sproutReports/deleteReport" data-confirm="Are you sure you want to delete this report?" data-redirect="sproutreports" tabindex="0">
				</p>
			{% endif %}

		</div>
	</div>

</form>

{% endblock %}
