{% import "_includes/forms" as forms %}
{% extends "sproutreports/_layouts/base" %}

{% set runReport = craft.request.getPost('runReport') %}
{% set report = craft.sproutReports.reportById(reportId) %}
{# TODO: need to do stuff in runReport function instead of #}
{% if runReport is empty and report.settings|length %}
    {% set results = [] %}
{% else %}
    {% set results = craft.sproutReports.runReport(report, craft.request.getPost('reportOptions')) %}
{% endif %}

{% set title = report.name %}

{% set crumbs = [
	{ label: "Reports"|t, url: url('sproutreports') },
	{ label: "View Results"|t, url: "" }
] %}

{% block content %}

<style type="text/css">
	.csv { display: inline-block; width: auto; }
</style>

<div class="tableview">
    {% if report.settings|length %}
    <div class="pane">
        <div class="tab">
            <h2>Select options</h2>
            <form action="" method="post" accept-charset="UTF-8">
                {% for optionName, option in report.settings %}
                    {# need to create chooseFormFieldByOptionType() function, someting like this #}
                    {{ forms.dateTimeField({
                        id: optionName,
                        label: option.name,
                        name: 'reportOptions[' ~ optionName ~ ']',
                        value: "",
                        errors: "",
                        required: false,
                    }) }}
                {% endfor %}
                <input type="hidden" name="runReport" value="1">
                <input type="submit" value="Run Report" class="btn submit">
            </form>
        </div>
    </div>
    {% endif %}
	<div class="tablecontent">
		
	{% for row in results %}
		{% if loop.first %}
		<table class="results">
			<thead>
				<tr>
				<th class="left-border"><div></div></th>
				<th class="padding"><div></div></th>
				{% for columnName, value in row %}
					<th><div {% if loop.index == "1" %}class="first"{% endif %}><h3>{{ columnName }}</h3></div></th>
				{% endfor %}
				</tr>
			</thead>
			<tbody>
		{% endif %}

			<tr class="table_row">
				<td class="left-border"><div></div></td>
		<td class="padding"></td>	
				{% for value in row %}
					<td><div class="item_content">{{ value }}</div></td>
				{% endfor %}
			</tr>

		{% if loop.last %}
		</table>
		{% endif %}

	{% endfor %}

	</div>
</div>
{{ parent() }}
{% endblock %}
