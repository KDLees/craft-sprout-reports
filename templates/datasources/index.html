{% extends "sproutreports/_layouts/base" %}
{% import "_includes/forms" as forms %}

{% set title  = "Data Sources"|t %}
{% set groups = craft.sproutReports.getReportGroups() %}

{% set selectedTab = 'dataSources' %}

{% if groupId is defined %}
	{% if groups[groupId] is not defined %}
		{% exit 404 %}
	{% endif %}

	{% set reports = craft.sproutReports.getReportsByGroupId(groupId) %}
{% else %}
	{% set reports = craft.sproutReports.getReports() %}
{% endif %}

{% block content %}
	<div class="tableview">
		<table class="data fullwidth">
			<thead>
			<tr>
				<th scope="col" data-attribute="datasource">Data Source</th>
				<th scope="col" data-attribute="description">Description</th>
				<th scope="col" data-attribute="plugin">Plugin</th>
				<th scope="col" data-attribute="status">{{ "Status"|t }}</th>
				<th scope="col" data-attribute="totalReports">Total Reports</th>
				<th class="thin"></th>
			</tr>
			</thead>
			<tbody>
			{% set dataSources = craft.sproutReports.getDataSources() %}

			{% for id, dataSource in dataSources %}
				<tr>
					<td><strong>{{ dataSource.getName() }}</strong></td>
					<td>{{ dataSource.getDescription() }}</td>
					<td><span class="light">{{ dataSource.getPluginName() }}</span></td>
                    <td>
                        {% set status = dataSource.getStatus() %}
                        {{ forms.lightswitchField({
                            id: dataSource.getId(),
                            on: status,
                            name: 'status'
                        }) }}
                    </td>
                    <td>{{ dataSource.getReportCount() }}</td>
					<td>
						<a href="{{ dataSource.getUrl('/new') }}" class="btn small">New Report</a>
					</td>

				</tr>
			{% endfor %}
			</tbody>
		</table>
	</div>

	<div class="grid">
		<div class="item">
			{{ parent() }}
		</div>
	</div>

{% endblock %}

{% includejs %}

    $(document).ready(function() {
        $('.lightswitch').change(function() {

            var status = $(this).find("[name='status']").val();
            var dataSourceId = $(this).attr('id');

            Craft.postActionRequest('sproutReports/reports/dataSourceStatus', {dataSourceId: dataSourceId, status: status}, function(response) {
                if (response)
                {
                    Craft.cp.displayNotice(Craft.t('Status Updated.'));
                }
            });
        })
    });

{% endincludejs %}